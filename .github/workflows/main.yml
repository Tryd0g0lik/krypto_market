name: CryptoMarket

on:
  push:
    branches: ['dev']

jobs:
    test_backend:
        name: Test Backend
        runs-on: ubuntu-latest
        env:
            POSTGRES_USER: ${{ secrets.POSTGRES_DB_USER }}
            POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
            POSTGRES_DB_PORT: ${{ secrets.POSTGRES_DB_PORT }}
            POSTGRES_DB_NAME: ${{ secrets.POSTGRES_DB }}
            POSTGRES_DB_HOST: ${{ secrets.POSTGRES_DB_HOST }}
            IS_DEBUG: 0
            DATABASE_URL: "postgresql://${{  secrets.POSTGRES_DB_USER }}:${{ secrets.POSTGRES_DB_PASSWORD }}@${{ secrets.POSTGRES_DB_HOST }}:${{ secrets.POSTGRES_DB_PORT }}/${{ secrets.POSTGRES_DB  }}"
            SECRET_KEY: ${{ secrets.SECRET_KEY }}
            DEBUG: "True"
        services:
            postgres:
                image: postgres:14
                env:
                    POSTGRES_USER: ${{  env.POSTGRES_USER  }}
                    POSTGRES_PASSWORD: ${{  env.POSTGRES_PASSWORD  }}
                    POSTGRES_DB: test_d
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
                ports:
                    - 5432:5432
        strategy:
            matrix:
                python-version: [ 3.13 ]
                fastapi-version: [ 0.126.0 ]
        steps:
            -   name: Checkout code
                uses: actions/checkout@v6.0.0

            -   name: Set up Python ${{  matrix.python-version  }}
                uses: actions/setup-python@v6.1.0
                with:
                    python-version: ${{  matrix.python-version  }}

            -   name: Install system dependencies
                run: |
                    sudo apt-get update
                    sudo apt-get install -y postgresql-client

            -   name: Cache pip packages
                uses: actions/cache@v4.3.0
                with:
                    path: ~/.cache/pip
                    key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt')  }}
                    restore-keys: |
                        ${{  runner.os  }}-pip-

            -   name: Install backend dependencies
                working-directory: .
                run: |
                    python -m pip install --upgrade pip
                    pip install -r requirements.txt
                    pip install pytest pytest-asyncio pytest-cov

            -   name: Run Alembic Revision
                env:
                    SMTP_PORT: 465
                    SECRET_KEY_DJ: ${{ env.SECRET_KEY }}
                    SECRET_KEY: ${{ env.SECRET_KEY }}
                    IS_DEBUG: 0
                run: |
                    alembic revision --auto

            -   name: Run Alembic migrate
                env:
                    SECRET_KEY_DJ: ${{ env.SECRET_KEY }}
                    SECRET_KEY: ${{ env.SECRET_KEY }}
                    POSTGRES_DB: ${{ env.POSTGRES_DB_NAME }}
                    POSTGRES_USER:  ${{ env.POSTGRES_USER }}
                    POSTGRES_PASSWORD:  ${{ env.POSTGRES_PASSWORD }}
                    POSTGRES_PORT: ${{ env.POSTGRES_DB_PORT }}
                    POSTGRES_HOST: ${{ env.POSTGRES_DB_HOST }}
                run: |
                    alembic upgrade head

            -   name: Run pre-commit hooks
                working-directory: .
                run: |
                    pip install pre-commit
                    pre-commit autoupdate
                    echo "Files that need fixing:"
                    pre-commit run --all-files --show-diff || true

        needs: deploy_market

    deploy_market:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version: [ '3.13' ]
        steps:
            # cache remove
            -   name: Clear GitHub Actions cache
                run: rm -rf $HOME/.cache/actions

    cicd_deploy:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version: [ '3.13' ]
        env:
            DEPLOY_HOST: ${{  secrets.SSH_HOST  }}
            DEPLOY_USER: ${{  secrets.SSH_USER  }}
            DEPLOY_KEY: ${{  secrets.SSH_KEY  }}
            DEPLOY_PASSWORD: ${{  secrets.SSH_PASSWORD  }}
        needs: test_backend
        steps:
            -   name: Deploy to GitHub Pages
                uses: appleboy/ssh-action@master
                with:
                    host: ${{  env.DEPLOY_HOST  }}
                    username: ${{  env.DEPLOY_USER  }}
                    password: ${{  env.DEPLOY_PASSWORD  }}
                    script: |
                        expect /home/denis/crypto/pull.exp
